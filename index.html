<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>每週伙食預算 (Customizable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 500: '#8B5CF6', 600: '#7C3AED' }, 
                        danger: { 500: '#EF4444' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-6 px-4 pb-20">

    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden relative">
        
        <button onclick="toggleSettings()" class="absolute top-4 right-4 text-purple-200 hover:text-white transition-colors z-10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </button>

        <div id="settingsPanel" class="hidden bg-purple-50 border-b border-purple-100 p-6 animate-fade-in-down">
    <label class="block text-xs font-bold text-purple-600 uppercase mb-2">設定每週固定預算</label>
    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
        <input id="totalBudgetInput" type="number" 
            class="w-full sm:flex-1 p-3 bg-white border-2 border-purple-200 rounded-lg text-lg font-bold text-purple-700 focus:outline-none focus:border-purple-500"
            placeholder="輸入預算">
        <button onclick="updateTotalBudget()" 
            class="w-full sm:w-auto px-6 py-3 bg-purple-600 text-white rounded-lg font-bold shadow-md active:bg-purple-700 transition-colors">
            儲存設定
        </button>
    </div>
    <p class="text-[10px] text-purple-400 mt-3 italic leading-relaxed">
        * 修改後將即時生效。如需特別行程（如國旅），可在這裡臨時調高。
    </p>
</div>
        
        <div id="statusCard" class="bg-gradient-to-br from-purple-500 to-indigo-600 text-white p-8 text-center transition-all duration-500">
            <p class="text-purple-100 text-sm font-medium tracking-wider uppercase mb-1">本週剩餘預算</p>
            <h1 class="text-5xl font-bold tracking-tight">$ <span id="balanceDisplay">2100</span></h1>
            <p class="text-xs text-purple-200 mt-2 opacity-70">總額: $<span id="currentTotalLabel">2100</span></p>
        </div>

        <div class="p-6 space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1 ml-1">金額</label>
                    <input id="amountInput" type="number" placeholder="0" inputmode="decimal" 
                        class="w-full text-xl font-bold p-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-brand-500 transition-all">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1 ml-1">日期時間</label>
                    <input id="timeInput" type="datetime-local" 
                        class="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl text-sm focus:outline-none focus:border-brand-500 transition-all">
                </div>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1 ml-1">備註</label>
                <input id="descInput" type="text" placeholder="例如：月津港晚餐、便當..." 
                    class="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-brand-500 transition-all">
            </div>

            <button id="actionBtn" onclick="handleAction()" 
                class="w-full py-4 bg-brand-600 text-white font-bold rounded-xl text-lg shadow-md active:scale-95 transition-all">
                新增支出
            </button>
            <button id="cancelEditBtn" onclick="cancelEdit()" class="hidden w-full py-2 bg-gray-200 text-gray-600 font-bold rounded-xl text-sm transition-all">取消修改</button>
        </div>

        <div class="bg-gray-50 border-t border-gray-100 min-h-[200px]">
            <div class="p-4">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">當週明細</h3>
                <div id="expenseList" class="space-y-2"></div>
            </div>
        </div>

        <div class="p-6 text-center border-t border-gray-200 bg-white">
            <button onclick="manualReset()" class="text-xs text-gray-400 hover:text-gray-600 underline decoration-gray-300 underline-offset-4">手動重置新的一週</button>
        </div>
    </div>

<script>
    // 初始化資料邏輯
    let data = JSON.parse(localStorage.getItem('food_budget_v4')) || { 
        lastReset: 0, 
        expenses: [],
        customTotal: 2100 // 儲存用戶自訂的總額
    };
    let editIndex = -1;

    function setDefaultTime() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('timeInput').value = now.toISOString().slice(0, 16);
    }

    function toggleSettings() {
        const panel = document.getElementById('settingsPanel');
        panel.classList.toggle('hidden');
        document.getElementById('totalBudgetInput').value = data.customTotal;
    }

    function updateTotalBudget() {
        const newTotal = parseFloat(document.getElementById('totalBudgetInput').value);
        if (isNaN(newTotal) || newTotal <= 0) { alert("請輸入有效的金額！"); return; }
        data.customTotal = newTotal;
        saveAndRender();
        toggleSettings();
    }

    function checkWeeklyReset() {
        const now = new Date();
        const day = now.getDay();
        const diff = now.getDate() - day + (day == 0 ? -6 : 1); 
        const thisMonday = new Date(now.setDate(diff)).setHours(0,0,0,0);
        if (data.lastReset < thisMonday) { performReset(); }
    }

    function performReset() { 
        data.expenses = []; 
        data.lastReset = Date.now(); 
        saveAndRender(); 
    }

    function manualReset() { if(confirm("確定要重置嗎？")) performReset(); }

    function handleAction() {
        const amountIn = document.getElementById('amountInput');
        const descIn = document.getElementById('descInput');
        const timeIn = document.getElementById('timeInput');
        
        const val = parseFloat(amountIn.value);
        const desc = descIn.value.trim() || "一般支出";
        const selectedTime = new Date(timeIn.value).getTime();

        if (isNaN(val) || val <= 0) { alert("請輸入正確金額！"); return; }

        const entry = { amount: val, note: desc, timestamp: selectedTime };
        if (editIndex === -1) { data.expenses.push(entry); } 
        else { data.expenses[editIndex] = entry; cancelEdit(); }
        
        data.expenses.sort((a, b) => b.timestamp - a.timestamp);
        amountIn.value = ''; descIn.value = ''; setDefaultTime();
        saveAndRender();
    }

    function startEdit(index) {
        editIndex = index;
        const item = data.expenses[index];
        document.getElementById('amountInput').value = item.amount;
        document.getElementById('descInput').value = item.note;
        const date = new Date(item.timestamp);
        date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
        document.getElementById('timeInput').value = date.toISOString().slice(0, 16);
        const btn = document.getElementById('actionBtn');
        btn.innerText = "確認修改";
        btn.classList.replace('bg-brand-600', 'bg-blue-600');
        document.getElementById('cancelEditBtn').classList.remove('hidden');
    }

    function cancelEdit() {
        editIndex = -1;
        document.getElementById('amountInput').value = '';
        document.getElementById('descInput').value = '';
        setDefaultTime();
        const btn = document.getElementById('actionBtn');
        btn.innerText = "新增支出";
        btn.classList.replace('bg-blue-600', 'bg-brand-600');
        document.getElementById('cancelEditBtn').classList.add('hidden');
    }

    function deleteItem(index) {
        if(confirm("確定刪除？")) { data.expenses.splice(index, 1); saveAndRender(); }
    }

    function saveAndRender() {
        localStorage.setItem('food_budget_v4', JSON.stringify(data));
        render();
    }

    function render() {
        const totalSpent = data.expenses.reduce((sum, item) => sum + item.amount, 0);
        const remaining = data.customTotal - totalSpent;
        
        document.getElementById('balanceDisplay').innerText = remaining;
        document.getElementById('currentTotalLabel').innerText = data.customTotal;
        
        document.getElementById('statusCard').className = remaining < 500 
            ? "bg-gradient-to-br from-red-500 to-rose-600 text-white p-8 text-center transition-all duration-500"
            : "bg-gradient-to-br from-purple-500 to-indigo-600 text-white p-8 text-center transition-all duration-500";

        const list = document.getElementById('expenseList');
        if (data.expenses.length === 0) {
            list.innerHTML = `<p class="text-center py-8 text-gray-400 text-sm">本週尚無支出</p>`;
        } else {
            list.innerHTML = data.expenses.map((item, index) => {
                const d = new Date(item.timestamp);
                const timeStr = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                return `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center transition-all">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-baseline space-x-2">
                            <span class="text-xl font-bold text-gray-800">$${item.amount}</span>
                            <span class="text-sm text-gray-600 truncate">${item.note}</span>
                        </div>
                        <div class="text-[10px] text-gray-400 uppercase mt-1">${timeStr}</div>
                    </div>
                    <div class="flex space-x-1 ml-2">
                        <button onclick="startEdit(${index})" class="p-2 text-blue-500 bg-blue-50 rounded-lg active:bg-blue-100 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                        <button onclick="deleteItem(${index})" class="p-2 text-red-500 bg-red-50 rounded-lg active:bg-red-100 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                </div>`;
            }).join('');
        }
    }

    setDefaultTime();
    checkWeeklyReset();
    render();
</script>
</body>
</html>
